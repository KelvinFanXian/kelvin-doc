# 小程序支付[ref](https://pay.weixin.qq.com/wiki/doc/apiv3_partner/open/pay/chapter2_8_1.shtml)

## 业务场景

- **第三方**服务商帮**商户**开发**小程序**，有三种业务场景
  - 1、第三方自己申请账号，自己开发，生成指定内页给特约商户用，该模式简称**中心化模式**。
    - 第三方的appid
  -  2、以特约商户身份申请小程序appid，第三方完成开发，该模式简称**外包模式**。
    - 商户的appid
  -  3、通过**开放平台**第三方开发者代特约商户进行小程序的开发，该模式简称**第三方模式**。
    - 

## 支付步骤

1. 后台下单
   - 普通模式
   - 普通服务商模式
   - 银行服务商模式
2. 前端js拉起收银台
   - 前端js拉起收银台需通过该小程序的appid，
     - 且该appid参与后台下单



## 业务场景$\times$ 后台下单模式

![image-20221207103011722](https://oss-kelvinvan.oss-cn-chengdu.aliyuncs.com/img/image-20221207103011722.png)



## 接入前准备

### 1.选择接入模式

1. 直连模式
2. 服务商模式

### 2. 参数申请

```bash
申请APPID(公众号)
申请mchid
绑定APPID及mchid
入驻子商户
```

### 3. 配置API key

```bash
登录微信服务商平台，进入【账户中心 > API安全】目录，设置APIV3密钥。
在弹出窗口中点击【已沟通】
输入API密钥，内容为32位字符，包括数字及大小写字母。点击获取短信验证码。
输入短信验证码，点击【确认】即设置成功。
```

### 4. 下载并配置商户证书

- 服务商可登录微信服务商平台，在【账户中心 -> API安全】目录下载证书

```bash
从2018年底开始，微信支付新入驻机构及商户都将使用CA签发证书，在证书申请页面上点击“申请证书”。
在弹出窗口中点击“确定”。
在弹出窗口内点击“下载证书工具”按钮下载证书工具。
安装证书工具并打开，选择证书需要存储的路径后点击“申请证书”。
在证书工具中，将复制的商户信息粘贴并点击“下一步”。
获取请求串
生成证书串
在【证书工具】-“生成证书”环节，已完成申请证书流程，点击“查看证书文件夹”，查看已生成的证书文件。
```

### 5.配置应用

```bash
1、申请小程序开发者账号，进行微信认证，获取appid登录《微信公众平台》，注册一个小程序的开发者账号。小程序账号申请指引
2、小程序开通微信支付，即申请或复用微信支付商户号，申请完小程序后，登录小程序后台。点击左侧导航栏的微信支付，在页面中进行开通。
```





## 开发指引

### 1. 接口规则

### 2. 开发准备

#### 2.1. 搭建和配置开发环境

```bash
1、选择对应的开发库并构建项目
2、创建加载商户私钥、加载平台证书、初始化httpClient的通用方法
3、基于接口的示例代码，替换请求参数后可发起测试
```

#### 2.2. 业务开发配置

- ###### 2.2.1.账号申请指引

```bash
a、小程序开通微信支付，即申请或复用微信支付商户号，申请完小程序后，登录小程序后台。点击左侧导航栏的微信支付，在页面中进行开通。（开通申请要求小程序已发布上线）
b、点击开通按钮后，有2种方式可以获取微信支付能力，新申请微信支付商户号或绑定一个已有的微信支付商户号，请根据你的业务需要和具体情况选择，只能二选一。开通指引
```

- ###### 2.2.2.服务器配置要求

``` bash
a、小程序访问商户服务都是通过HTTPS,开发部署的时候需要HTTPS服务器
b、服务器域名配置
	①、每个微信小程序需要事先设置通信域名，小程序只可以跟指定的域名进行网络通信。包括普通 HTTPS 请求（wx.request）、上传文件（wx.uploadFile）、下载文件（wx.downloadFile）和 WebSocket 通信（wx.connectSocket）
	②、从基础库 2.4.0 开始，网络接口允许与局域网 IP 通信，但不允许与本机 IP 通信


```



## 快速接入

### 1.业务流程

![](https://pay.weixin.qq.com/wiki/doc/apiv3/assets/img/pay/wechatpay/6_2.png)

### 2. API接入（含示例代码）